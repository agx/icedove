From: Mike Hommey <glandium@debian.org>
Date: Wed, 14 Apr 2010 08:59:59 +0200
Subject: Do build time detection of 2-bytes wchar_t and char16_t support

https://bugzilla.mozilla.org/show_bug.cgi?id=559278
Closes: #577677 - in xulrunner
Ported to icedove by Christoph Goehre <chris@sigxcpu.org>


---
 mozilla/xpcom/base/nscore.h                   |   22 ++++++++++++++++++++++
 mozilla/xpcom/glue/nsStringAPI.h              |    1 +
 mozilla/xpcom/string/public/nsLiteralString.h |    1 +
 3 files changed, 24 insertions(+)

Index: icedove/mozilla/xpcom/base/nscore.h
===================================================================
--- icedove.orig/mozilla/xpcom/base/nscore.h	2012-10-13 14:27:23.110188983 +0530
+++ icedove/mozilla/xpcom/base/nscore.h	2012-10-13 15:56:42.738437912 +0530
@@ -345,6 +345,28 @@
   #define HAVE_CPP_2BYTE_WCHAR_T
 #endif
 
+#ifdef __GNUC__
+/* char16_t is only available in gcc 4.4+ with experimental c++0x support
+ * (-std=c++0x or -std=gnu++0x) */
+#if defined(HAVE_CPP_CHAR16_T) && (__GNUC__ < 4 || (__GNUC__ == 4 && __GNUC_MINOR__ < 4) || !defined(__GXX_EXPERIMENTAL_CXX0X__))
+#warning icedove SDK was configured with char16_t support, but now building without
+#undef HAVE_CPP_CHAR16_T
+#elif ! defined(HAVE_CPP_CHAR16_T) && (__GNUC__ > 4 || (__GNUC__ == 4 && __GNUC_MINOR__ >= 4)) && defined(__GXX_EXPERIMENTAL_CXX0X__)
+#warning icedove SDK was configured without char16_t support, but now building with
+#define HAVE_CPP_CHAR16_T
+#endif
+
+/* When gcc is not given -fshort-wchar, wchar_t is not 2-bytes wide */
+#if defined(HAVE_CPP_2BYTE_WCHAR_T) && (__SIZEOF_WCHAR_T__ != 2)
+#warning icedove SDK was configured with 2-byte wchar_t, but now building without
+#undef HAVE_CPP_2BYTE_WCHAR_T
+#elif ! defined(HAVE_CPP_2BYTE_WCHAR_T) && (__SIZEOF_WCHAR_T__ == 2)
+#warning icedove SDK was configured without 2-byte wchar_t, but now building with
+#define HAVE_CPP_2BYTE_WCHAR_T
+#endif
+
+#endif
+
 #ifndef __PRUNICHAR__
 #define __PRUNICHAR__
   /* For now, don't use wchar_t on Unix because it breaks the Netscape
Index: icedove/mozilla/xpcom/glue/nsStringAPI.h
===================================================================
--- icedove.orig/mozilla/xpcom/glue/nsStringAPI.h	2012-10-13 14:27:23.158188984 +0530
+++ icedove/mozilla/xpcom/glue/nsStringAPI.h	2012-10-13 15:56:42.738437912 +0530
@@ -1076,6 +1076,7 @@
   #define NS_NAMED_MULTILINE_LITERAL_STRING(n,s)  const nsDependentString n(reinterpret_cast<const nsAString::char_type*>(s), PRUint32((sizeof(s)/2)-1))
   typedef nsDependentString nsLiteralString;
 #else
+  #warning Using conversions for literal strings. Please consider using 2-bytes wchar_t or char16_t instead
   #define NS_LL(s)                                s
   #define NS_MULTILINE_LITERAL_STRING(s)          NS_ConvertASCIItoUTF16(s, PRUint32(sizeof(s)-1))
   #define NS_MULTILINE_LITERAL_STRING_INIT(n,s)   n(s, PRUint32(sizeof(s)-1))
Index: icedove/mozilla/xpcom/string/public/nsLiteralString.h
===================================================================
--- icedove.orig/mozilla/xpcom/string/public/nsLiteralString.h	2012-10-13 14:27:23.230188989 +0530
+++ icedove/mozilla/xpcom/string/public/nsLiteralString.h	2012-10-13 15:56:42.738437912 +0530
@@ -58,6 +58,7 @@
   #define NS_NAMED_MULTILINE_LITERAL_STRING(n,s)  const nsDependentString n(reinterpret_cast<const nsAString::char_type*>(s), PRUint32((sizeof(s)/2)-1))
   typedef nsDependentString nsLiteralString;
 #else
+  #warning Using conversions for literal strings. Please consider using 2-bytes wchar_t or char16_t instead
   #define NS_LL(s)                                s
   #define NS_MULTILINE_LITERAL_STRING(s)          NS_ConvertASCIItoUTF16(s, PRUint32(sizeof(s)-1))
   #define NS_MULTILINE_LITERAL_STRING_INIT(n,s)   n(s, PRUint32(sizeof(s)-1))
