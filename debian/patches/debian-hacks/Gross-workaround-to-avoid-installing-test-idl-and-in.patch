From: Mike Hommey <mh@glandium.org>
Date: Wed, 27 Jan 2010 17:47:57 +0100
Subject: Gross workaround to avoid installing test idl and include files in
 the SDK

https://bugzilla.mozilla.org/show_bug.cgi?id=542749


---
 mozilla/config/rules.mk        |   14 ++++++++++++--
 mozilla/js/src/config/rules.mk |   14 ++++++++++++--
 2 files changed, 24 insertions(+), 4 deletions(-)

Index: icedove/mozilla/config/rules.mk
===================================================================
--- icedove.orig/mozilla/config/rules.mk	2012-10-13 14:27:16.746188687 +0530
+++ icedove/mozilla/config/rules.mk	2012-10-13 15:57:19.458439617 +0530
@@ -32,6 +32,16 @@
 EXPORTS += $(SDK_HEADERS)
 endif
 
+ifneq (,$(findstring sample,$(MODULE))$(findstring test,$(MODULE))$(findstring Test,$(MODULE)))
+INCLUDE_DIR := $(DIST)/include/testing
+IDL_DIR := $(DIST)/tests/idl
+LOCAL_INCLUDES += -I$(XPIDL_GEN_DIR) -I$(INCLUDE_DIR)
+override MOZ_JAVAXPCOM :=
+XPIDL_FLAGS += -I$(DIST)/idl
+else
+INCLUDE_DIR := $(DIST)/include
+endif
+
 REPORT_BUILD = @echo $(notdir $<)
 
 ifeq ($(OS_ARCH),OS2)
@@ -1354,8 +1364,8 @@
 export:: $(XPIDLSRCS) $(IDL_DIR)
 	$(INSTALL) $(IFLAGS1) $^
 
-export:: $(patsubst %.idl,$(XPIDL_GEN_DIR)/%.h, $(XPIDLSRCS)) $(DIST)/include
-	$(INSTALL) $(IFLAGS1) $^
+export:: $(patsubst %.idl,$(XPIDL_GEN_DIR)/%.h, $(XPIDLSRCS)) $(INCLUDE_DIR)
+	$(INSTALL) $(IFLAGS1) $^ 
 endif # NO_DIST_INSTALL
 
 endif # XPIDLSRCS
Index: icedove/mozilla/js/src/config/rules.mk
===================================================================
--- icedove.orig/mozilla/js/src/config/rules.mk	2012-10-13 14:27:19.670188822 +0530
+++ icedove/mozilla/js/src/config/rules.mk	2012-10-13 15:57:19.458439617 +0530
@@ -32,6 +32,16 @@
 EXPORTS += $(SDK_HEADERS)
 endif
 
+ifneq (,$(findstring sample,$(MODULE))$(findstring test,$(MODULE))$(findstring Test,$(MODULE)))
+INCLUDE_DIR := $(DIST)/include/testing
+IDL_DIR := $(DIST)/tests/idl
+LOCAL_INCLUDES += -I$(XPIDL_GEN_DIR) -I$(INCLUDE_DIR)
+override MOZ_JAVAXPCOM :=
+XPIDL_FLAGS += -I$(DIST)/idl
+else
+INCLUDE_DIR := $(DIST)/include
+endif
+
 REPORT_BUILD = @echo $(notdir $<)
 
 ifeq ($(OS_ARCH),OS2)
@@ -1354,8 +1364,8 @@
 export:: $(XPIDLSRCS) $(IDL_DIR)
 	$(INSTALL) $(IFLAGS1) $^
 
-export:: $(patsubst %.idl,$(XPIDL_GEN_DIR)/%.h, $(XPIDLSRCS)) $(DIST)/include
-	$(INSTALL) $(IFLAGS1) $^
+export:: $(patsubst %.idl,$(XPIDL_GEN_DIR)/%.h, $(XPIDLSRCS)) $(INCLUDE_DIR)
+	$(INSTALL) $(IFLAGS1) $^ 
 endif # NO_DIST_INSTALL
 
 endif # XPIDLSRCS
