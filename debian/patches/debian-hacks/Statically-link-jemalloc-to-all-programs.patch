From: Mike Hommey <mh@glandium.org>
Date: Fri, 21 Oct 2011 18:01:25 +0200
Subject: (Statically) link jemalloc to all programs

---
 mozilla/config/config.mk        |    4 ++--
 mozilla/config/rules.mk         |    4 ++++
 mozilla/js/src/config/config.mk |    4 ++--
 mozilla/js/src/config/rules.mk  |    4 ++++
 4 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/mozilla/config/config.mk b/mozilla/config/config.mk
index 4b306d6..37ea697 100644
--- a/mozilla/config/config.mk
+++ b/mozilla/config/config.mk
@@ -151,11 +151,11 @@ MOZ_WIDGET_SUPPORT_LIBS    = $(DIST)/lib/$(LIB_PREFIX)widgetsupport_s.$(LIB_SUFF
 
 ifdef MOZ_MEMORY
 ifneq ($(OS_ARCH),WINNT)
-JEMALLOC_LIBS = $(MKSHLIB_FORCE_ALL) $(call EXPAND_MOZLIBNAME,jemalloc) $(MKSHLIB_UNFORCE_ALL)
+MOZ_JEMALLOC_LIBS = $(MKSHLIB_FORCE_ALL) $(call EXPAND_MOZLIBNAME,jemalloc) $(MKSHLIB_UNFORCE_ALL)
 # If we are linking jemalloc into a program, we want the jemalloc symbols
 # to be exported
 ifneq (,$(SIMPLE_PROGRAMS)$(PROGRAM))
-JEMALLOC_LIBS += $(MOZ_JEMALLOC_STANDALONE_GLUE_LDOPTS)
+MOZ_JEMALLOC_LIBS += $(MOZ_JEMALLOC_STANDALONE_GLUE_LDOPTS)
 endif
 endif
 endif
diff --git a/mozilla/config/rules.mk b/mozilla/config/rules.mk
index 97ce4ff..dbe4947 100644
--- a/mozilla/config/rules.mk
+++ b/mozilla/config/rules.mk
@@ -80,6 +80,10 @@ else
 EXEC			= exec
 endif
 
+ifneq (,$(SIMPLE_PROGRAMS)$(PROGRAM))
+LIBS += $(MOZ_JEMALLOC_LIBS)
+endif
+
 # Don't copy xulrunner files at install time, when using system xulrunner
 ifdef SYSTEM_LIBXUL
   SKIP_COPY_XULRUNNER=1
diff --git a/mozilla/js/src/config/config.mk b/mozilla/js/src/config/config.mk
index 4b306d6..37ea697 100644
--- a/mozilla/js/src/config/config.mk
+++ b/mozilla/js/src/config/config.mk
@@ -151,11 +151,11 @@ MOZ_WIDGET_SUPPORT_LIBS    = $(DIST)/lib/$(LIB_PREFIX)widgetsupport_s.$(LIB_SUFF
 
 ifdef MOZ_MEMORY
 ifneq ($(OS_ARCH),WINNT)
-JEMALLOC_LIBS = $(MKSHLIB_FORCE_ALL) $(call EXPAND_MOZLIBNAME,jemalloc) $(MKSHLIB_UNFORCE_ALL)
+MOZ_JEMALLOC_LIBS = $(MKSHLIB_FORCE_ALL) $(call EXPAND_MOZLIBNAME,jemalloc) $(MKSHLIB_UNFORCE_ALL)
 # If we are linking jemalloc into a program, we want the jemalloc symbols
 # to be exported
 ifneq (,$(SIMPLE_PROGRAMS)$(PROGRAM))
-JEMALLOC_LIBS += $(MOZ_JEMALLOC_STANDALONE_GLUE_LDOPTS)
+MOZ_JEMALLOC_LIBS += $(MOZ_JEMALLOC_STANDALONE_GLUE_LDOPTS)
 endif
 endif
 endif
diff --git a/mozilla/js/src/config/rules.mk b/mozilla/js/src/config/rules.mk
index 97ce4ff..dbe4947 100644
--- a/mozilla/js/src/config/rules.mk
+++ b/mozilla/js/src/config/rules.mk
@@ -80,6 +80,10 @@ else
 EXEC			= exec
 endif
 
+ifneq (,$(SIMPLE_PROGRAMS)$(PROGRAM))
+LIBS += $(MOZ_JEMALLOC_LIBS)
+endif
+
 # Don't copy xulrunner files at install time, when using system xulrunner
 ifdef SYSTEM_LIBXUL
   SKIP_COPY_XULRUNNER=1
-- 
