From: Mike Hommey <mh@glandium.org>
Date: Fri, 29 Jan 2010 16:36:46 +0100
Subject: [PATCH] Override intl.locale.matchOS if general.useragent.locale is set in user profile

This allows the Quick Locale Switcher extension to work.

https://bugzilla.mozilla.org/show_bug.cgi?id=542999
---
 mozilla/chrome/src/nsChromeRegistry.cpp |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/mozilla/chrome/src/nsChromeRegistry.cpp b/mozilla/chrome/src/nsChromeRegistry.cpp
index 91c5738..96d3376 100644
--- a/mozilla/chrome/src/nsChromeRegistry.cpp
+++ b/mozilla/chrome/src/nsChromeRegistry.cpp
@@ -1466,10 +1466,11 @@ nsresult
 nsChromeRegistry::SelectLocalePref(nsIPrefBranch* prefs)
 {
   nsresult rv;
-  PRBool matchOSLocale = PR_FALSE;
+  PRBool matchOSLocale = PR_FALSE, userLocaleOverride = PR_FALSE;
+  prefs->PrefHasUserValue(SELECTED_LOCALE_PREF, &userLocaleOverride);
   rv = prefs->GetBoolPref(MATCH_OS_LOCALE_PREF, &matchOSLocale);
 
-  if (NS_SUCCEEDED(rv) && matchOSLocale) {
+  if (NS_SUCCEEDED(rv) && matchOSLocale && !userLocaleOverride) {
     // compute lang and region code only when needed!
     nsCAutoString uiLocale;
     rv = getUILangCountry(uiLocale);
-- 
