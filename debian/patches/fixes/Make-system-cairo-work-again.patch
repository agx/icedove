From: =?UTF-8?q?Guido=20G=C3=BCnther?= <agx@sigxcpu.org>
Date: Tue, 12 Jun 2012 20:25:34 +0200
Subject: Make system cairo work again

BZ: https://bugzilla.mozilla.org/show_bug.cgi?id=722975
Patch: https://bug722975.bugzilla.mozilla.org/attachment.cgi?id=624394

---
 mozilla/gfx/thebes/gfxPlatform.cpp |   16 ++++------------
 1 file changed, 4 insertions(+), 12 deletions(-)

Index: icedove/mozilla/gfx/thebes/gfxPlatform.cpp
===================================================================
--- icedove.orig/mozilla/gfx/thebes/gfxPlatform.cpp	2012-10-15 20:21:45.455202222 +0530
+++ icedove/mozilla/gfx/thebes/gfxPlatform.cpp	2012-10-15 20:40:41.759254997 +0530
@@ -496,11 +496,9 @@
   static_cast<SourceSurface*>(srcBuffer)->Release();
 }
 
-void SourceSnapshotDetached(cairo_surface_t *nullSurf)
+void SourceSnapshotDetached(void *nullSurf)
 {
-  gfxImageSurface* origSurf =
-    static_cast<gfxImageSurface*>(cairo_surface_get_user_data(nullSurf, &kSourceSurface));
-
+  gfxImageSurface *origSurf = static_cast<gfxImageSurface*>(nullSurf);
   origSurf->SetData(&kSourceSurface, NULL, NULL);
 }
 
@@ -597,14 +595,8 @@
 
     }
 
-    cairo_surface_t *nullSurf =
-	cairo_null_surface_create(CAIRO_CONTENT_COLOR_ALPHA);
-    cairo_surface_set_user_data(nullSurf,
-                                &kSourceSurface,
-                                imgSurface,
-                                NULL);
-    cairo_surface_attach_snapshot(imgSurface->CairoSurface(), nullSurf, SourceSnapshotDetached);
-    cairo_surface_destroy(nullSurf);
+    cairo_surface_set_mime_data(imgSurface->CairoSurface(), "mozilla/magic",
+		(const unsigned char *) "data", 4, SourceSnapshotDetached, imgSurface.get());
   }
 
   srcBuffer->AddRef();
