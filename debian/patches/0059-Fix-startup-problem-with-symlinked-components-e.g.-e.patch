From: Christoph Goehre <chris@sigxcpu.org>
Date: Fri, 20 Aug 2010 19:14:17 +0200
Subject: [PATCH] Fix startup problem with symlinked components (e.g. extensions)

https://bugzilla.mozilla.org/show_bug.cgi?id=551152
Closes: #592531
---
 .../xptinfo/src/xptiInterfaceInfoManager.cpp       |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/mozilla/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp b/mozilla/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp
index 57f6df9..f0d94b6 100644
--- a/mozilla/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp
+++ b/mozilla/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp
@@ -629,16 +629,17 @@ IndexOfDirectoryOfFile(nsISupportsArray* aSearchPath, nsILocalFile* aFile)
         NS_ASSERTION(count, "broken search path! bad count");
         for(PRUint32 i = 0; i < count; i++)
         {
-            nsCOMPtr<nsIFile> current;
+            nsCOMPtr<nsIFile> current, normalized;
             aSearchPath->QueryElementAt(i, NS_GET_IID(nsIFile), 
                                         getter_AddRefs(current));
             NS_ASSERTION(current, "broken search path! bad element");
             // nsIFile::Equals basically compares path strings so normalize
             // before the comparison.
             parent->Normalize();
-            current->Normalize();
+            current->Clone(getter_AddRefs(normalized));
+            normalized->Normalize();
             PRBool same;
-            if (NS_SUCCEEDED(parent->Equals(current, &same)) && same)
+            if (NS_SUCCEEDED(parent->Equals(normalized, &same)) && same)
                 return (int) i;
         }
     }
-- 
